'''
get the top 1000 most common features
X = vectorize 10000 sample images using those 1000 features
Y = additionally, save the rating for each of those images
break up the examples into training and testing
fit the garbage to X_train and Y_train
check fit with X_test and Y_test
'''

from bs4 import BeautifulSoup
import numpy as np
from collections import defaultdict
import time, datetime
from tqdm import tqdm
import dateutil.parser


def timestamp():
    return datetime.datetime.fromtimestamp(time.time()).strftime('%Y-%m-%d %H:%M:%S')

# data="""1girl solo long_hair breasts blush highres short_hair smile open_mouth blonde_hair blue_eyes brown_hair multiple_girls touhou female black_hair looking_at_viewer skirt thighhighs red_eyes nipples hat large_breasts 1boy underwear 2girls ribbon censored twintails brown_eyes gloves panties school_uniform simple_background blue_hair dress hair_ornament green_eyes original navel bow nude penis ass pussy animal_ears cleavage sitting eyes_closed purple_eyes translation_request purple_hair weapon jewelry pink_hair bad_id cum white_background monochrome ponytail shirt bare_shoulders red_hair sex kantai_collection hair_ribbon yellow_eyes very_long_hair swimsuit sweat tail multiple_boys green_hair glasses silver_hair wings absurdres lying black_legwear tears male_focus boots hair_bow barefoot flower hairband braid pantyhose uncensored serafuku vaginal japanese_clothes spread_legs heart huge_breasts ahoge comic game_cg detached_sleeves lowres tagme standing long_sleeves bikini feet tongue loli necktie looking_back white_hair thighs sword midriff 2boys one_eye_closed flat_chest shoes :d elbow_gloves open_clothes earrings food sky legs solo_focus bangs striped areolae pointy_ears cat_ears hetero wink 3girls yuri vocaloid white_legwear translated socks erect_nipples collarbone fang bed pink_eyes chibi animated official_art anus shorts full_body hairclip orange_hair bra pleated_skirt belt frills choker idolmaster horns uniform saliva black_eyes dark_skin cum_in_pussy fingerless_gloves pussy_juice upper_body alternate_costume bdsm pubic_hair bottomless animated_gif scarf holding no_panties from_behind jacket side_ponytail zettai_ryouiki on_back white_panties water cape gradient aqua_eyes oral tongue_out small_breasts pokemon gradient_background sketch bound short_sleeves armor bondage armpits cosplay twin_braids no_bra open_shirt cloud artist_request bunny_ears hatsune_miku cum_on_body maid collar necklace torn_clothes cat_tail outdoors photo kimono star grabbing breast_grab kneeling apron anal fellatio multicolored_hair toes mahou_shoujo_madoka_magica hug puffy_sleeves grin hair_flower high_heels pantyshot gun wet bag lips topless aqua_hair blood book :o lingerie fate_(series) shiny 4koma teeth character_name indoors sweatdrop grey_hair siblings hakurei_reimu mosaic_censoring miniskirt arms_up white_gloves bracelet rape nail_polish magical_girl hood upskirt bent_over pillow group_sex personification kirisame_marisa facial tree kneehighs cameltoe dutch_angle parody shiny_skin pants 4girls shirt_lift vest skirt_lift military headband cum_on_upper_body shota one-piece_swimsuit sleeveless headphones makeup yaoi parted_lips sideboob fruit wide_sleeves witch_hat testicles maid_headdress capcom wrist_cuffs precure nintendo hair_over_one_eye underboob chains 6+girls scan bodysuit final_fantasy plaid undressing girl_on_top ascot military_uniform striped_legwear text petals orange_eyes character_request drill_hair hand_on_hip see-through long_image hand_holding remilia_scarlet cum_on_breasts sidelocks v child izayoi_sakuya cowboy_shot moon idolmaster_cinderella_girls eyepatch panty_pull umbrella happy traditional_media hair_between_eyes handjob bat_wings pokemon_(game) paizuri no_humans sweater artist_name muscle striped_panties lipstick school_swimsuit mole couple flandre_scarlet ejaculation tattoo pov bowtie hair_tubes double_bun footwear mask straddling black_gloves tentacle hair_bobbles :3 gundam short_twintails trap back monster_girl wide_hips erection alternate_hairstyle rose thigh_boots crossover all_fours mouth_hold tall_image hips glowing genderswap black_panties blunt_bangs k-on! puffy_nipples arms_behind_back 3boys jojo_no_kimyou_na_bouken masturbation bell sash monster leotard ^_^ fate/stay_night two_side_up cover signature plump soles copyright_name breasts_outside age_difference night dated single_braid heterochromia english sleeping embarrassed face tan cat curvy fingering asian sisters thick_thighs capelet gangbang kiss off_shoulder coat wariza bird arm_up cum_in_mouth miko patchouli_knowledge looking_at_another wallpaper headgear blush_stickers profile alice_margatroid eating source_request window licking garter_straps grey_eyes clothed_sex arm_support cup formal leaf 5girls lyrical_nanoha katana scar on_side commentary_request symbol-shaped_pupils beach breast_press suzumiya_haruhi_no_yuuutsu kochiya_sanae underwear_only crossdressing hands plaid_skirt bandage aftersex chinese_clothes side-tie_bikini thigh_gap bare_legs hoodie naruto rope eyebrows crossed_arms futanari hat_ribbon younger sandals cirno chair white_dress white_shirt helmet love_live!_school_idol_project facial_hair fox_ears dress_shirt wince yakumo_yukari covering mound_of_venus naughty_face groin mahou_shoujo_lyrical_nanoha cumdrip demon_girl convenient_censoring abs beret atlus leaning_forward konpaku_youmu tokin_hat bike_shorts pink_panties androgynous two-tone_hair nature huge_ass angry one_piece fox_tail knife neon_genesis_evangelion bouncing_breasts stuffed_toy trembling cum_on_hair milf clenched_teeth antenna_hair from_above spread_pussy the_embodiment_of_scarlet_devil cum_on_lower_body squatting frown turtleneck suit outstretched_arms suspenders sparkle akemi_homura blazer instrument polearm from_below surprised skirt_set fangs no_shoes doggystyle ocean multiple_tails mecha restrained fingernails md5_mismatch strike_witches wolf_ears drooling oekaki sailor_collar bunnysuit stuffed_animal elf >_< puffy_short_sleeves persona third_eye staff fire goggles knee_boots no_pants fujiwara_no_mokou kaname_madoka bed_sheet short_shorts wavy_mouth shadow head_tilt tales_of_(series) shameimaru_aya neckerchief eyelashes casual facial_mark breast_hold looking_down ass_grab twitter_username side-tie_panties hong_meiling black_dress cross bikini_top tanline head_wings checkered :< light_smile street_fighter ahegao crescent denim cherry_blossoms on_stomach gradient_hair crown feathers towel pointing screencap tiara table backpack legs_crossed to_aru_majutsu_no_index object_insertion blue_dress lactation fan saigyouji_yuyuko breast_squeeze polka_dot jpeg_artifacts dual_persona reisen_udongein_inaba clitoris bukkake cleavage_cutout cover_page cuffs garter_belt pale_skin mob_cap butterfly christmas spoilers komeiji_koishi letterboxed multiple_penises expressionless photoshop thong :p witch crop_top hair_bun microphone panties_around_leg broom crying tank_top shinkaisei-kan grass dildo straight_shota youkai furry ring between_breasts vibrator inubashiri_momiji gauntlets from_side obi komeiji_satori phone legs_up twin_drills foreshortening miki_sayaka no_hat glowing_eyes 6+boys horn gym_uniform looking_up pointless_censoring skin_tight watermark detached_collar sunglasses lolita_fashion mary_janes admiral_(kantai_collection) inazuma_eleven_(series) cowgirl_position fate/zero snow lucky_star china_dress skindentation blue_sky ;d heart-shaped_pupils wavy_hair animal butt_crack headset 3d musical_note cum_in_ass bottle long_legs looking_away blue_skirt hand_on_head armband kagamine_rin arc_system_works saber panties_aside tomoe_mami grey_background fishnets buruma thigh_strap full_moon transparent_background bob_cut piercing leg_up sunlight dress_lift incest snake bishoujo_senshi_sailor_moon moriya_suwako fire_emblem clothed_female_nude_male code_geass short_dress top-down_bottom-up sleeves_past_wrists yakumo_ran carrying kemonomimi_mode gag wind everyone dragon_quest rumia kill_la_kill twins wristband femdom red_dress cardigan sakura_kyouko kazami_yuuka corset adapted_costume fat slave steam cellphone sitting_on_person strap_slip 4boys yu-gi-oh! claws fucked_silly outstretched_arm size_difference hime_cut dog ? chen flying_sweatdrops plant minigirl empty_eyes candy bow_panties sheath wet_clothes reiuji_utsuho blazblue santa_hat forest kamishirasawa_keine white_swimsuit dog_ears blue_background vehicle lavender_hair blurry gigantic_breasts o_o skull konpaku_youmu_(ghost) santa_costume close-up hat_bow peaked_cap loafers brother_and_sister dual_wielding orgasm couch eyebrows_visible_through_hair brooch bunny_tail front-tie_top missionary happy_sex spear black_skirt hanging_breasts flying on_bed panties_under_pantyhose closed_mouth revision wolf_tail older pink_background anger_vein slit_pupils dakimakura kawashiro_nitori bridal_gauntlets persona_4 cum_on_clothes curtains handgun lace pendant mahou_shoujo_lyrical_nanoha_strikers akiyama_mio leg_lift breath rifle upside-down bestiality machinery buttons peeing ghost leash sweater_vest bespectacled bar_censor hinanawi_tenshi bleach tengen_toppa_gurren_lagann fur_trim shield queen's_blade collared_shirt frog chouzuki_maryou alcohol scenery eye_contact star_(sky) remodel_(kantai_collection) monogatari_(series) doll headwear_removed blouse clenched_hand soryu_asuka_langley rozen_maiden shaded_face shimakaze_(kantai_collection) spot_color kaenbyou_rin ball sneakers new_year speech_bubble fish kaga_(kantai_collection) covered_navel shiny_hair t-shirt box spiked_hair bunny the_legend_of_zelda bow_(weapon) floral_print desk micro_bikini to_aru_kagaku_no_railgun red-framed_glasses depth_of_field double_penetration veil parted_bangs umineko_no_naku_koro_ni pose building megurine_luka scrunchie gothic_lolita highleg cum_on_ass inazuma_eleven tatara_kogasa pink_bow hairpin nurse halterneck halloween strapless condom cake camisole pokemon_bw black_wings bandaid camera covering_breasts ibuki_suika nipple_slip footjob half_updo gift smile_precure! kagamine_len touken_ranbu snk v_arms red_bow houraisan_kaguya beard nontraditional_miko low_twintails copyright_request succubus bath injury sailor_dress zoom_layer finger_to_mouth nakano_azusa final_fantasy_vii hands_on_hips /\/\/\ realistic koakuma motor_vehicle suzumiya_haruhi mystia_lorelei =_= randoseru inaba_tewi sunset |_| pregnant sarashi border ice bubble teacup cigarette areola_slip nagato_yuki hand_on_own_chest open_jacket fate_testarossa blue_skin yasaka_kanako cross-laced_footwear ninja no_headwear king_of_fighters geta pajamas torn_pantyhose red_skirt freckles waitress holding_weapon garters fat_man impossible_clothes side_slit hand_on_another's_head wedding_dress girls_und_panzer angel_wings pink_dress unzipped bloomers breast_sucking hijiri_byakuren arms_behind_head sexually_suggestive running sleeveless_shirt folded_ponytail large_areolae guitar gym_leader league_of_legends top_hat fake_animal_ears innertube underwater hat_removed rain antennae ofuda dragon_ball colored_eyelashes red_ribbon shingeki_no_kyojin hirasawa_yui hug_from_behind"""
# data="""0_0 69 :>= aftersex anal anal_fingering anal_object_insertion anus bestiality bisexual bubble_skirt bukkake buttjob caesar_anthonio_zeppeli caressing_testicles circle_anco cleft_of_venus clitoris clothed_female_nude_male clothed_sex cowgirl_position cross_section cum cum_explosion cum_in_ass cum_in_mouth cum_in_pussy cum_on_ass cum_on_body cum_on_breasts cum_on_clothes cum_on_hair cum_on_lower_body cum_on_tongue cum_on_upper_body cum_pool cum_string cum_while_penetrated cumdrip cunnilingus danmaku dark_penis disembodied_penis doggystyle double_handjob double_penetration ejaculation erection facial fellatio female_ejaculation flaccid footjob foreskin fucked_silly full-package_futanari futa_with_female futa_with_male futanari gangbang gaping gears group_sex gumi hand_in_pocket handjob happy_sex held_up huge_penis inflation interracial joseph_joestar_(young) kiso_(kantai_collection) landscape large_insertion large_penis little_penis lolita_channel male_pubic_hair missionary mizuki_hitoshi mosaic_censoring multiple_penises object_insertion oral orgasm orgy overflow paizuri panties_aside patterned_legwear penetration penis pointless_censoring portrait precum pussy rape real_life_insert rebecca_(keinelove) reverse_cowgirl_position saberfish scenery sex shaved_pussy skirt_set solid_circle_eyes spitroast spooning spread_anus spread_pussy stand_(jojo) steel_ball_run stomach_bulge style_parody swimsuit_aside tani_takeshi tegaki testicles threesome turret uncensored urethra vaginal vaginal_object_insertion veiny_penis virgin waistcoat watercolor_(medium) winter_clothes |_|"""
data="""cum_while_penetrated circle_anco urethra ejaculation double_handjob dark_penis cum_in_pussy cum_in_ass cum_explosion veiny_penis orgy lolita_channel cum_pool vaginal spitroast multiple_penises gangbang foreskin cumdrip cum_on_hair cum_on_ass cum_in_mouth bukkake tani_takeshi reverse_cowgirl_position overflow large_penis facial double_penetration cum_string cum spread_anus huge_penis handjob group_sex futa_with_male fellatio cum_on_upper_body cum_on_tongue cum_on_lower_body cum_on_clothes cum_on_breasts cum_on_body caressing_testicles precum penetration large_insertion gaping disembodied_penis full-package_futanari penis missionary male_pubic_hair buttjob virgin spread_pussy sex oral doggystyle vaginal_object_insertion testicles patterned_legwear fucked_silly anal held_up futa_with_female rebecca_(keinelove) paizuri threesome happy_sex female_ejaculation cowgirl_position anal_fingering clitoris stomach_bulge scenery panties_aside mizuki_hitoshi clothed_sex tegaki footjob bestiality :>= real_life_insert object_insertion anus mosaic_censoring rape flaccid anal_object_insertion pointless_censoring orgasm futanari clothed_female_nude_male interracial cunnilingus stand_(jojo) steel_ball_run aftersex solid_circle_eyes saberfish danmaku watercolor_(medium) spooning little_penis landscape waistcoat shaved_pussy bisexual erection caesar_anthonio_zeppeli 69 hand_in_pocket 0_0 cross_section inflation portrait skirt_set |_| winter_clothes pussy bubble_skirt joseph_joestar_(young) turret uncensored style_parody gears gumi cleft_of_venus swimsuit_aside kiso_(kantai_collection) rubbing flat_cap emiya_kiritsugu artist_self-insert spread_ass northern_ocean_hime jonathan_joestar hands_in_pockets chibi bridge maribel_hearn grinding epic teamwork pixiv_fantasia machinery ahegao kagerou_project xd pillow_hat muneate morichika_rinnosuke torii oriental_umbrella medicine_melancholy child 4koma kariginu kaburagi_t_kotetsu jojo_no_kimyou_na_bouken contemporary animalization anchor_symbol soga_no_tojiko shanghai_doll karakasa_obake ascot usami_renko tasuki rolling_eyes microphone_stand touhou_(pc-98) red_jacket pussy_juice male kuujou_joutarou bar_censor tate_eboshi sukuna_shinmyoumaru lancer_(fate/zero) anal_beads shoulder_bag gohei cityscape kakyouin_noriaki long_coat hand_on_headwear forced dildo arm_cannon pompadour mittens mahou_shoujo_madoka_magica_movie holding_sword dio_brando barnaby_brooks_jr no_humans casual torso_grab red_moon moaning busou_renkin branch wagashi spoken_ellipsis rod_of_remorse juliet_sleeves wide_sleeves blue_rose princess_carry fat_man teapot straight_shota mecha hammer_(sunset_beach) akebono_(kantai_collection) x-ray silent_comic petting kotomine_kirei winter stubble multiple_4koma lance hat_bow used_condom shimenawa japanese_armor kumoi_ichirin fingering album_cover yin_yang waist_apron kamen_rider holding_book explosion censored geta flying teacup science_fiction inazuma_eleven_go upright_straddle snowflakes black_rock_shooter_(character) umbrella tengu-geta mob_cap masturbation lantern autumn_leaves aki_shizuha parasol maple_leaf house soccer_uniform female_admiral_(kantai_collection) throwing_knife tatara_kogasa singing shigure_(kantai_collection) ice_wings hat_ribbon goatee girl_on_top fate/zero cravat hair_flaps green_dress cookie ^_^ ruins purple_dress plaid_vest heart_of_string happy_birthday fubuki_(kantai_collection) bouquet bird kijin_seija hoshizora_rin costume_switch concept_art cannon basket >:d straddling puffy_sleeves gourd castle back-to-back scabbard light_particles legwear_under_shorts crystal yukikaze_(kantai_collection) naval_uniform musical_note murasa_minamitsu kotatsu broom >_< star_(sky) red_rose puffy_short_sleeves neckerchief kagamine_rin gakuran black_serafuku akagi_(kantai_collection) mononobe_no_futo hiei_(kantai_collection) gilgamesh flag broom_riding bow_(weapon) sunflower space scroll guitar gap fujiwara_no_mokou building toyosatomimi_no_miko road long_skirt holding_weapon futatsuiwa_mamizou fork capelet armored_dress wo-class_aircraft_carrier shaded_face pocket_watch kisume kirisame_marisa armored_core aki_minoriko yuudachi_(kantai_collection) tiger_&_bunny pokemon_rgby jacket_on_shoulders inazuma_(kantai_collection) gift_box earmuffs blue_dress twitter_username newhalf frilled_skirt remodel_(kantai_collection) red_(pokemon) ofuda miyako_yoshika meiko glowing_eye front_ponytail fire dark-skinned_male comic witch spear skirt_hold flat_gaze trench_coat touken_ranbu tassel shorts_under_skirt shiranui_(kantai_collection) shinkaisei-kan rice pink_rose letterboxed leaf_hair_ornament lap_pillow lace-up_boots koizumi_hanayo frilled_dress floating coat cherry_blossoms yukkuri_shiteitte_ne eating nontraditional_miko hibiki_(kantai_collection) vest time_paradox short_sleeves red_dress polearm kasodani_kyouko frilled_sleeves clothed_male_nude_female cirno chen battle akatsuki_(kantai_collection) >:) yellow walking trident top_hat starry_sky sleeveless_dress parody kaito formal folding_fan field =_= pubic_hair pom_pom_(clothes) azasuke toramaru_shou seiyuu_connection mountain ikazuchi_(kantai_collection) houraisan_kaguya father_and_son creature snowing puffy_long_sleeves petals outstretched_hand lily_white kagiyama_hina houshou_(kantai_collection) cloudy_sky pointing open_book mystia_lorelei letty_whiterock instrument full_moon chess_piece assault_rifle arrow sword_girls sash leaf_on_head konpaku_youmu_(ghost) hitodama company_connection sheath horn_ribbon fusion food_on_face bread archer adapted_costume sailor_hat osomatsu-kun hakama bamboo aura superhero rumia osomatsu-san ice hieda_no_akyuu falling alternate_costume railing plaid_shirt oversized_object flame suit pikachu index_finger_raised butterfly white_dress vibrator ultimate_madoka smoke shawl sailor_dress ribbon-trimmed_sleeves over_shoulder ooi_(kantai_collection) kagamine_len fighting_stance animal wind sheathed paper multiple_persona bird_wings streaked_hair obi o_o military_vehicle kitakami_(kantai_collection) jitome hakama_skirt cake ... pink_dress imaizumi_kagerou lily_(flower) grapes tea red_scarf public pecs outstretched_arm official_style fish dual_wielding chopsticks carrying spoilers scythe running outstretched_arms alternate_hair_length triangular_headpiece torpedo soul_gem plate hakurei_reimu floral_background checkered_skirt brooch black_skirt black_rock_shooter black_dress younger tank pouch mini_hat katana earphones city alternate_eye_color zuikaku_(kantai_collection) sakura_kyouko mustache microphone manly hooded_jacket gift daiyousei character_name :t string spoon remilia_scarlet rain leaf komeiji_koishi hands_together waving tales_of_xillia tabard scarf miki_sayaka long_sleeves hands_on_own_face cross-laced_footwear commentary_request colored_pencil_(medium) black_shoes bara assertive apple sun_hat rose nazrin mankanshoku_mako leg_grab kousaka_honoka handbag glowing single_earring rainbow panties_around_leg mini_top_hat darker_than_black danganronpa_1 argyle stairs sailor_collar sailor reverse_trap hata_no_kokoro glowing_eyes airplane ship shield hands_clasped green_skirt beard narukami_yuu mouse head_wreath hatsune_miku animal_hat military_hat ghost fox_mask charlotte_(madoka_magica) vocaloid umineko_no_naku_koro_ni crescent_moon cabbie_hat bespectacled zettai_ryouiki sparkle reading pipe kyubey kurodani_yamame headwear_removed facial_hair collared_shirt yazawa_nico snow night_sky handheld_game_console digital_media_player character_doll breastplate alice_margatroid yasaka_kanako rifle moon kirito kamishirasawa_keine kaku_seiga from_software doll shota hat_removed anchor traditional_media spread_arms red_bow kawashiro_nitori jumping jiangshi huge_weapon flying_sweatdrops floating_hair flandre_scarlet epaulettes butt_plug book third_eye orange_skirt murakumo_(kantai_collection) monkey_d_luffy mizuhashi_parsee hammer folded enmaided card argyle_legwear adjusting_glasses sonoda_umi skeleton maid_apron dual_persona doughnut chin_rest blue salute idolmaster_million_live! akemi_homura vertical-striped_legwear triangle_mouth sword river pun no_hat motorcycle mobile_suit_gundam kemonomimi_mode fate/grand_order copyright_name arm_ribbon alternate_hairstyle spring_onion simon ryuujou_(kantai_collection) red pink_skirt nishikino_maki moriya_suwako konpaku_youmu key hong_meiling youkai shiki_eiki red_skirt paintbrush cat blush_stickers no_headwear hair_tubes cup angel_beats! yellow_dress star pocky kaname_madoka fan yakumo_ran track_suit mouse_ears magic_circle graphite_(medium) ex-keine chouzuki_maryou anger_vein"""
# data="""... /\/\/\ 0_0 1boy 1girl 2boys 2girls 3boys 3d 3girls 4boys 4girls 4koma 5girls 6+boys 6+girls 69 :3 :< :>= :d :o :p :t ;d =_= >:) >:d >_< ? ^_^ abs absurdres adapted_costume adjusting_glasses admiral_(kantai_collection) aftersex age_difference ahegao ahoge airplane akagi_(kantai_collection) akatsuki_(kantai_collection) akebono_(kantai_collection) akemi_homura aki_minoriko aki_shizuha akiyama_mio album_cover alcohol alice_margatroid all_fours alternate_costume alternate_eye_color alternate_hair_length alternate_hairstyle anal anal_beads anal_fingering anal_object_insertion anchor anchor_symbol androgynous angel_beats! angel_wings anger_vein angry animal animal_ears animal_hat animalization animated animated_gif antenna_hair antennae anus apple apron aqua_eyes aqua_hair arc_system_works archer areola_slip areolae argyle argyle_legwear arm_cannon arm_ribbon arm_support arm_up armband armor armored_core armored_dress armpits arms_behind_back arms_behind_head arms_up arrow artist_name artist_request artist_self-insert ascot asian ass ass_grab assault_rifle assertive atlus aura autumn_leaves azasuke back back-to-back backpack bad_id bag ball bamboo bandage bandaid bangs bar_censor bara bare_legs bare_shoulders barefoot barnaby_brooks_jr basket bat_wings bath battle bdsm beach beard bed bed_sheet bell belt bent_over beret bespectacled bestiality between_breasts bike_shorts bikini bikini_top bird bird_wings bisexual bishoujo_senshi_sailor_moon black_dress black_eyes black_gloves black_hair black_legwear black_panties black_rock_shooter black_rock_shooter_(character) black_serafuku black_shoes black_skirt black_wings blazblue blazer bleach blonde_hair blood bloomers blouse blue blue_background blue_dress blue_eyes blue_hair blue_rose blue_skin blue_skirt blue_sky blunt_bangs blurry blush blush_stickers bob_cut bodysuit bondage book boots border bottle bottomless bouncing_breasts bound bouquet bow bow_(weapon) bow_panties bowtie box bra bracelet braid branch bread breast_grab breast_hold breast_press breast_squeeze breast_sucking breastplate breasts breasts_outside breath bridal_gauntlets bridge brooch broom broom_riding brother_and_sister brown_eyes brown_hair bubble bubble_skirt building bukkake bunny bunny_ears bunny_tail bunnysuit buruma busou_renkin butt_crack butt_plug butterfly buttjob buttons cabbie_hat caesar_anthonio_zeppeli cake cameltoe camera camisole candy cannon capcom cape capelet card cardigan caressing_testicles carrying castle casual cat cat_ears cat_tail cellphone censored chains chair character_doll character_name character_request charlotte_(madoka_magica) checkered checkered_skirt chen cherry_blossoms chess_piece chibi child chin_rest china_dress chinese_clothes choker chopsticks chouzuki_maryou christmas cigarette circle_anco cirno city cityscape claws cleavage cleavage_cutout cleft_of_venus clenched_hand clenched_teeth clitoris close-up closed_mouth clothed_female_nude_male clothed_male_nude_female clothed_sex cloud cloudy_sky coat code_geass collar collarbone collared_shirt colored_eyelashes colored_pencil_(medium) comic commentary_request company_connection concept_art condom contemporary convenient_censoring cookie copyright_name copyright_request corset cosplay costume_switch couch couple cover cover_page covered_navel covering covering_breasts cowboy_shot cowgirl_position cravat creature crescent crescent_moon crop_top cross cross-laced_footwear cross_section crossdressing crossed_arms crossover crown crying crystal cuffs cum cum_explosion cum_in_ass cum_in_mouth cum_in_pussy cum_on_ass cum_on_body cum_on_breasts cum_on_clothes cum_on_hair cum_on_lower_body cum_on_tongue cum_on_upper_body cum_pool cum_string cum_while_penetrated cumdrip cunnilingus cup curtains curvy daiyousei dakimakura danganronpa_1 danmaku dark-skinned_male dark_penis dark_skin darker_than_black dated demon_girl denim depth_of_field desk detached_collar detached_sleeves digital_media_player dildo dio_brando disembodied_penis dog dog_ears doggystyle doll double_bun double_handjob double_penetration doughnut dragon_ball dragon_quest dress dress_lift dress_shirt drill_hair drooling dual_persona dual_wielding dutch_angle earmuffs earphones earrings eating ejaculation elbow_gloves elf embarrassed emiya_kiritsugu empty_eyes english enmaided epaulettes epic erect_nipples erection everyone ex-keine explosion expressionless eye_contact eyebrows eyebrows_visible_through_hair eyelashes eyepatch eyes_closed face facial facial_hair facial_mark fake_animal_ears falling fan fang fangs fat fat_man fate/grand_order fate/stay_night fate/zero fate_(series) fate_testarossa father_and_son feathers feet fellatio female female_admiral_(kantai_collection) female_ejaculation femdom field fighting_stance final_fantasy final_fantasy_vii finger_to_mouth fingering fingerless_gloves fingernails fire fire_emblem fish fishnets flaccid flag flame flandre_scarlet flat_cap flat_chest flat_gaze floating floating_hair floral_background floral_print flower flying flying_sweatdrops folded folded_ponytail folding_fan food food_on_face footjob footwear forced foreshortening foreskin forest fork formal fox_ears fox_mask fox_tail freckles frilled_dress frilled_skirt frilled_sleeves frills frog from_above from_behind from_below from_side from_software front-tie_top front_ponytail frown fruit fubuki_(kantai_collection) fucked_silly fujiwara_no_mokou full-package_futanari full_body full_moon fur_trim furry fusion futa_with_female futa_with_male futanari futatsuiwa_mamizou gag gakuran game_cg gangbang gap gaping garter_belt garter_straps garters gauntlets gears genderswap geta ghost gift gift_box gigantic_breasts gilgamesh girl_on_top girls_und_panzer glasses gloves glowing glowing_eye glowing_eyes goatee goggles gohei gothic_lolita gourd grabbing gradient gradient_background gradient_hair grapes graphite_(medium) grass green_dress green_eyes green_hair green_skirt grey_background grey_eyes grey_hair grin grinding groin group_sex guitar gumi gun gundam gym_leader gym_uniform hair_between_eyes hair_bobbles hair_bow hair_bun hair_flaps hair_flower hair_ornament hair_over_one_eye hair_ribbon hair_tubes hairband hairclip hairpin hakama hakama_skirt hakurei_reimu half_updo halloween halterneck hammer hammer_(sunset_beach) hand_holding hand_in_pocket hand_on_another's_head hand_on_head hand_on_headwear hand_on_hip hand_on_own_chest handbag handgun handheld_game_console handjob hands hands_clasped hands_in_pockets hands_on_hips hands_on_own_face hands_together hanging_breasts happy happy_birthday happy_sex hat hat_bow hat_removed hat_ribbon hata_no_kokoro hatsune_miku head_tilt head_wings head_wreath headband headgear headphones headset headwear_removed heart heart-shaped_pupils heart_of_string held_up helmet hetero heterochromia hibiki_(kantai_collection) hieda_no_akyuu hiei_(kantai_collection) high_heels highleg highres hijiri_byakuren hime_cut hinanawi_tenshi hips hirasawa_yui hitodama holding holding_book holding_sword holding_weapon hong_meiling hood hooded_jacket hoodie horn horn_ribbon horns hoshizora_rin houraisan_kaguya house houshou_(kantai_collection) hug hug_from_behind huge_ass huge_breasts huge_penis huge_weapon ibuki_suika ice ice_wings idolmaster idolmaster_cinderella_girls idolmaster_million_live! ikazuchi_(kantai_collection) imaizumi_kagerou impossible_clothes inaba_tewi inazuma_(kantai_collection) inazuma_eleven inazuma_eleven_(series) inazuma_eleven_go incest index_finger_raised indoors inflation injury innertube instrument interracial inubashiri_momiji izayoi_sakuya jacket jacket_on_shoulders japanese_armor japanese_clothes jewelry jiangshi jitome jojo_no_kimyou_na_bouken jonathan_joestar joseph_joestar_(young) jpeg_artifacts juliet_sleeves jumping k-on! kaburagi_t_kotetsu kaenbyou_rin kaga_(kantai_collection) kagamine_len kagamine_rin kagerou_project kagiyama_hina kaito kaku_seiga kakyouin_noriaki kamen_rider kamishirasawa_keine kaname_madoka kantai_collection karakasa_obake kariginu kasodani_kyouko katana kawashiro_nitori kazami_yuuka kemonomimi_mode key kijin_seija kill_la_kill kimono king_of_fighters kirisame_marisa kirito kiso_(kantai_collection) kiss kisume kitakami_(kantai_collection) knee_boots kneehighs kneeling knife koakuma kochiya_sanae koizumi_hanayo komeiji_koishi komeiji_satori konpaku_youmu konpaku_youmu_(ghost) kotatsu kotomine_kirei kousaka_honoka kumoi_ichirin kurodani_yamame kuujou_joutarou kyubey lace lace-up_boots lactation lance lancer_(fate/zero) landscape lantern lap_pillow large_areolae large_breasts large_insertion large_penis lavender_hair leaf leaf_hair_ornament leaf_on_head league_of_legends leaning_forward leash leg_grab leg_lift leg_up legs legs_crossed legs_up legwear_under_shorts leotard letterboxed letty_whiterock licking light_particles light_smile lily_(flower) lily_white lingerie lips lipstick little_penis loafers loli lolita_channel lolita_fashion long_coat long_hair long_image long_legs long_skirt long_sleeves looking_at_another looking_at_viewer looking_away looking_back looking_down looking_up love_live!_school_idol_project low_twintails lowres lucky_star lying lyrical_nanoha machinery magic_circle magical_girl mahou_shoujo_lyrical_nanoha mahou_shoujo_lyrical_nanoha_strikers mahou_shoujo_madoka_magica mahou_shoujo_madoka_magica_movie maid maid_apron maid_headdress makeup male male_focus male_pubic_hair mankanshoku_mako manly maple_leaf maribel_hearn mary_janes mask masturbation md5_mismatch mecha medicine_melancholy megurine_luka meiko micro_bikini microphone microphone_stand midriff miki_sayaka miko milf military military_hat military_uniform military_vehicle mini_hat mini_top_hat minigirl miniskirt missionary mittens miyako_yoshika mizuhashi_parsee mizuki_hitoshi moaning mob_cap mobile_suit_gundam mole monkey_d_luffy monochrome monogatari_(series) mononobe_no_futo monster monster_girl moon morichika_rinnosuke moriya_suwako mosaic_censoring motor_vehicle motorcycle mound_of_venus mountain mouse mouse_ears mouth_hold multicolored_hair multiple_4koma multiple_boys multiple_girls multiple_penises multiple_persona multiple_tails muneate murakumo_(kantai_collection) murasa_minamitsu muscle musical_note mustache mystia_lorelei nagato_yuki nail_polish nakano_azusa narukami_yuu naruto nature naughty_face naval_uniform navel nazrin neckerchief necklace necktie neon_genesis_evangelion new_year newhalf night night_sky ninja nintendo nipple_slip nipples nishikino_maki no_bra no_hat no_headwear no_humans no_panties no_pants no_shoes nontraditional_miko northern_ocean_hime nude nurse o_o obi object_insertion ocean oekaki off_shoulder official_art official_style ofuda older on_back on_bed on_side on_stomach one-piece_swimsuit one_eye_closed one_piece ooi_(kantai_collection) open_book open_clothes open_jacket open_mouth open_shirt oral orange_eyes orange_hair orange_skirt orgasm orgy oriental_umbrella original osomatsu-kun osomatsu-san outdoors outstretched_arm outstretched_arms outstretched_hand over_shoulder overflow oversized_object paintbrush paizuri pajamas pale_skin panties panties_around_leg panties_aside panties_under_pantyhose pants panty_pull pantyhose pantyshot paper parasol parody parted_bangs parted_lips patchouli_knowledge patterned_legwear peaked_cap pecs peeing pendant penetration penis persona persona_4 personification petals petting phone photo photoshop piercing pikachu pillow pillow_hat pink_background pink_bow pink_dress pink_eyes pink_hair pink_panties pink_rose pink_skirt pipe pixiv_fantasia plaid plaid_shirt plaid_skirt plaid_vest plant plate pleated_skirt plump pocket_watch pocky pointing pointless_censoring pointy_ears pokemon pokemon_(game) pokemon_bw pokemon_rgby polearm polka_dot pom_pom_(clothes) pompadour ponytail portrait pose pouch pov precum precure pregnant princess_carry profile pubic_hair public puffy_long_sleeves puffy_nipples puffy_short_sleeves puffy_sleeves pun purple_dress purple_eyes purple_hair pussy pussy_juice queen's_blade railing rain rainbow randoseru rape reading real_life_insert realistic rebecca_(keinelove) red red-framed_glasses red_(pokemon) red_bow red_dress red_eyes red_hair red_jacket red_moon red_ribbon red_rose red_scarf red_skirt reisen_udongein_inaba reiuji_utsuho remilia_scarlet remodel_(kantai_collection) restrained reverse_cowgirl_position reverse_trap revision ribbon ribbon-trimmed_sleeves rice rifle ring river road rod_of_remorse rolling_eyes rope rose rozen_maiden rubbing ruins rumia running ryuujou_(kantai_collection) saber saberfish saigyouji_yuyuko sailor sailor_collar sailor_dress sailor_hat sakura_kyouko saliva salute sandals santa_costume santa_hat sarashi sash scabbard scan scar scarf scenery school_swimsuit school_uniform science_fiction screencap scroll scrunchie scythe see-through seiyuu_connection serafuku sex sexually_suggestive shaded_face shadow shameimaru_aya shanghai_doll shaved_pussy shawl sheath sheathed shield shigure_(kantai_collection) shiki_eiki shimakaze_(kantai_collection) shimenawa shingeki_no_kyojin shinkaisei-kan shiny shiny_hair shiny_skin ship shiranui_(kantai_collection) shirt shirt_lift shoes short_dress short_hair short_shorts short_sleeves short_twintails shorts shorts_under_skirt shota shoulder_bag siblings side-tie_bikini side-tie_panties side_ponytail side_slit sideboob sidelocks signature silent_comic silver_hair simon simple_background singing single_braid single_earring sisters sitting sitting_on_person size_difference skeleton sketch skin_tight skindentation skirt skirt_hold skirt_lift skirt_set skull sky slave sleeping sleeveless sleeveless_dress sleeveless_shirt sleeves_past_wrists slit_pupils small_breasts smile smile_precure! smoke snake sneakers snk snow snowflakes snowing soccer_uniform socks soga_no_tojiko soles solid_circle_eyes solo solo_focus sonoda_umi soryu_asuka_langley soul_gem source_request space sparkle spear speech_bubble spiked_hair spitroast spoilers spoken_ellipsis spoon spooning spot_color spread_anus spread_arms spread_ass spread_legs spread_pussy spring_onion squatting staff stairs stand_(jojo) standing star star_(sky) starry_sky steam steel_ball_run stomach_bulge straddling straight_shota strap_slip strapless streaked_hair street_fighter strike_witches string striped striped_legwear striped_panties stubble stuffed_animal stuffed_toy style_parody succubus suit sukuna_shinmyoumaru sun_hat sunflower sunglasses sunlight sunset superhero surprised suspenders suzumiya_haruhi suzumiya_haruhi_no_yuuutsu sweat sweatdrop sweater sweater_vest swimsuit swimsuit_aside sword sword_girls symbol-shaped_pupils t-shirt tabard table tagme tail tales_of_(series) tales_of_xillia tall_image tan tani_takeshi tank tank_top tanline tassel tasuki tatara_kogasa tate_eboshi tattoo tea teacup teamwork teapot tears teeth tegaki tengen_toppa_gurren_lagann tengu-geta tentacle testicles text the_embodiment_of_scarlet_devil the_legend_of_zelda thick_thighs thigh_boots thigh_gap thigh_strap thighhighs thighs third_eye thong threesome throwing_knife tiara tiger_&_bunny time_paradox to_aru_kagaku_no_railgun to_aru_majutsu_no_index toes tokin_hat tomoe_mami tongue tongue_out top-down_bottom-up top_hat topless toramaru_shou torii torn_clothes torn_pantyhose torpedo torso_grab touhou touhou_(pc-98) touken_ranbu towel toyosatomimi_no_miko track_suit traditional_media translated translation_request transparent_background trap tree trembling trench_coat triangle_mouth triangular_headpiece trident turret turtleneck twin_braids twin_drills twins twintails twitter_username two-tone_hair two_side_up ultimate_madoka umbrella umineko_no_naku_koro_ni uncensored underboob underwater underwear underwear_only undressing uniform unzipped upper_body upright_straddle upside-down upskirt urethra usami_renko used_condom v v_arms vaginal vaginal_object_insertion vehicle veil veiny_penis vertical-striped_legwear very_long_hair vest vibrator virgin vocaloid wagashi waist_apron waistcoat waitress walking wallpaper wariza water watercolor_(medium) watermark waving wavy_hair wavy_mouth weapon wedding_dress wet wet_clothes white_background white_dress white_gloves white_hair white_legwear white_panties white_shirt white_swimsuit wide_hips wide_sleeves wince wind window wings wink winter winter_clothes witch witch_hat wo-class_aircraft_carrier wolf_ears wolf_tail wrist_cuffs wristband x-ray xd yakumo_ran yakumo_yukari yaoi yasaka_kanako yazawa_nico yellow yellow_dress yellow_eyes yin_yang youkai younger yu-gi-oh! yukikaze_(kantai_collection) yukkuri_shiteitte_ne yuri yuudachi_(kantai_collection) zettai_ryouiki zoom_layer zuikaku_(kantai_collection) |_|"""
tags = data.split(" ")
index_map = defaultdict()
for i, tag in enumerate(tags):
	index_map[tag] = i

def vectorize(tags):
	vector = [False]*len(index_map)
	for tag in tags:
		if tag in index_map.keys():
			index = index_map[tag]
			vector[index] = True
	return vector

# sample_size = 1E3
# sample_size = 10E3
sample_size = 1*100E3
# sample_size = -1


X = []
Y = []

if sample_size == -1:
	sample_size = 3004112
with open("../all_gelbooru.xml", "r") as f:
	for i, line in tqdm(enumerate(f), total=sample_size):
		if i < sample_size:
			# if i % 1000 == 0:
			# 	print("[{}] processing item {:07} / 3000000".format(timestamp(), i))
			soup = BeautifulSoup(line, "lxml")
			post = soup.find("post")
			if post is not None:
				tags = post["tags"].strip().split(" ")
				# print(tags)

				rating = post["rating"]
				# print(rating)
				
				rating_num = 0
				if rating == "s":
					rating_num = 0
				elif rating == "q":
					rating_num = 1
				elif rating == "e":
					rating_num = 2

				creation_date_string = post["created_at"]
				creation_date = dateutil.parser.parse(creation_date_string).timestamp()
				
				num_tags = len(tags)

				# x_sample = [creation_date, num_tags] + vectorize(tags)
				x_sample = vectorize(tags)
				y_sample = rating_num

				X.append(x_sample)
				Y.append(y_sample)
		else:
			break

X = np.array(X)
Y = np.array(Y)

training_proportion = 0.8
train_test_split_index = int(len(X)*training_proportion)
X_train, X_test = X[:train_test_split_index], X[train_test_split_index:]
Y_train, Y_test = Y[:train_test_split_index], Y[train_test_split_index:]


# a=np.array([X_train]).T
# b=np.array([Y_train]).T.reshape(1, train_test_split_index, 1)
# print(a.shape)
# print(b.shape)
# training_pairs = np.concatenate((), 1)
# testing_pairs = np.concatenate((np.array([X_test]).T, np.array([Y_test]).T.reshape(1, train_test_split_index, 1)), 1)



# #naive bayes
# from sklearn.naive_bayes import GaussianNB
# gnb = GaussianNB()
# y_pred_nb = gnb.fit(X_train, Y_train).predict(X_test)
# print("Naive Bayes - Error rate: {:.05}".format(1.0*(Y_test != y_pred_nb).sum()/X_test.shape[0]))

# #decision tree
# from sklearn import tree
# clf = tree.DecisionTreeClassifier(max_features=0.5,max_depth=5)
# clf = clf.fit(X_train, Y_train)
# y_pred_dt = clf.predict(X_test)
# print("Decision tree - Error rate: {:.05}".format(1.0*(Y_test != y_pred_dt).sum()/X_test.shape[0]))

# C=1e6 #0.28
# C=1e5 #0.275
# C=5e4 #0.275
# C=2e4 #0.275
C=1e4 #0.255 #0.1125
# C=9.5e3 #0.255
# C=9e3 #0.255
# C=5e3 #0.26
# C=1e3 #0.26
# C=1e2 #0.295

from sklearn import linear_model
logreg = linear_model.LogisticRegression(C=C)
logreg.fit(X_train, Y_train)
y_pred_lr = logreg.predict(X_test)
print("Logistic regression (c={}) - Error rate: {}".format(C, 1.0*(Y_test != y_pred_lr).sum()/X_test.shape[0]))



# #multi layer perceptron
# from sklearn.neural_network import MLPClassifier
# clf = MLPClassifier(algorithm='l-bfgs', alpha=1e-5, hidden_layer_sizes=(5, 2), random_state=1)
# clf.fit(X_train, Y_train)
# y_pred_mlp = clf.predict(X_test)
# print("Decision tree - Error rate: {:.05}".format(1.0*(Y_test != y_pred_mlp).sum()/X_test.shape[0]))

# import tensorflow.contrib.learn.python.learn as learn
# from sklearn import datasets, metrics
# classifier = learn.LinearClassifier(n_classes=3)
# classifier.fit(X_train, Y_train, steps=200, batch_size=32)
# score = metrics.accuracy_score(Y_test, classifier.predict(X_train))
# print("Linear classifier - Accuracy: {}".format(score))

